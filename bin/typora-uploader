#!/usr/bin/env node
const fs = require('fs-extra')
const path = require('path')
const { ELECTRON_SCRIPT_NAME } = require('../lib/constant')

const commands = ['inject', 'run', 'build', 'help']

let cmd = process.argv[2]

if (cmd) {
	// 命令简写转换
	if (cmd.length === 1) {
		const mapToCmd = {
			i: 'inject',
			r: 'run',
			b: 'build',
			h: 'help'
		}
		cmd = mapToCmd[cmd]
	}

	if (commands.includes(cmd)) {
		// 删除掉cmd，传递给下一级就只剩下对应的参数了
		process.argv.splice(2, 1)
	} else {
		if (cmd === '-v' || cmd === '--version') {
			console.log(require('../package.json').version)
			process.exit(0)
		}

		const { log, warn } = require('../lib/helpers/logger')

		if (cmd === '-h' || cmd === '--help') {
			cmd = 'help'
		} else {
			warn(`Unsupported command`)
			cmd = 'help'
		}
	}
} else {
	cmd = 'help'
}

// 拷贝脚本
if (['run', 'build'].includes(cmd)) {
	const scriptsPath = path.resolve(process.cwd(), ELECTRON_SCRIPT_NAME)
	if (!fs.existsSync(scriptsPath)) {
		fs.copySync(path.resolve(__dirname, '../lib'), scriptsPath)
	}
}

// 执行命令
require(`./${cmd}`)
